generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String             @id @default(cuid())
  email           String             @unique
  name            String?
  nickname        String?            @unique
  bio             String?            @db.Text
  image           String?
  passwordHash    String?
  emailVerified   DateTime?
  role            UserRole           @default(USER)
  neighborhoods   UserNeighborhood[]
  posts           Post[]
  comments        Comment[]
  reports         Report[]           @relation("ReportedBy")
  receivedReports Report[]           @relation("ReportedUser")
  reportAudits    ReportAudit[]      @relation("ReportAuditResolvedBy")
  sanctionsReceived UserSanction[]   @relation("SanctionedUser")
  sanctionsIssued   UserSanction[]   @relation("SanctionModerator")
  blocksGiven       UserBlock[]      @relation("UserBlocksGiven")
  blocksReceived    UserBlock[]      @relation("UserBlocksReceived")
  mutesGiven        UserMute[]       @relation("UserMutesGiven")
  mutesReceived     UserMute[]       @relation("UserMutesReceived")
  pets              Pet[]
  audienceSegments  UserAudienceSegment[]
  passwordResets  PasswordResetToken[]
  authAudits      AuthAuditLog[]
  postReactions   PostReaction[]
  commentReactions CommentReaction[]
  notifications   Notification[]     @relation("NotificationRecipient")
  actions         Notification[]     @relation("NotificationActor")
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  accounts        Account[]
  sessions        Session[]
}

enum PetSpecies {
  DOG
  CAT
}

enum PetSizeClass {
  TOY
  SMALL
  MEDIUM
  LARGE
  GIANT
  UNKNOWN
}

enum PetLifeStage {
  PUPPY_KITTEN
  YOUNG
  ADULT
  SENIOR
  UNKNOWN
}

model BreedCatalog {
  id          String       @id @default(cuid())
  species     PetSpecies
  code        String
  labelKo     String
  aliases     String[]
  defaultSize PetSizeClass
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([species, code])
  @@index([species, labelKo])
}

model Pet {
  id        String   @id @default(cuid())
  userId    String
  name      String
  species   PetSpecies
  breedCode String?
  breedLabel String?
  sizeClass PetSizeClass @default(UNKNOWN)
  lifeStage PetLifeStage @default(UNKNOWN)
  age       Int?
  imageUrl  String?
  bio       String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@index([userId, createdAt(sort: Desc)])
  @@index([species, breedCode])
  @@index([sizeClass, lifeStage])
}

model UserAudienceSegment {
  id              String       @id @default(cuid())
  userId          String
  species         PetSpecies?
  breedCode       String?
  sizeClass       PetSizeClass?
  lifeStage       PetLifeStage?
  interestTags    String[]
  confidenceScore Float        @default(0.5)
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([userId])
  @@index([species, breedCode, sizeClass, lifeStage])
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

model Neighborhood {
  id           String             @id @default(cuid())
  name         String
  city         String
  district     String
  lat          Float?
  lng          Float?
  users        UserNeighborhood[]
  posts        Post[]
  @@unique([name, city, district], name: "name_city_district")
}

model UserNeighborhood {
  id             String       @id @default(cuid())
  userId         String
  neighborhoodId String
  isPrimary      Boolean      @default(false)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  neighborhood   Neighborhood @relation(fields: [neighborhoodId], references: [id])
  @@unique([userId, neighborhoodId])
}

model Post {
  id               String          @id @default(cuid())
  authorId         String
  guestAuthorId    String?
  guestDisplayName String?
  guestIpDisplay   String?
  guestIpLabel     String?
  guestPasswordHash String?
  guestIpHash      String?
  guestFingerprintHash String?
  neighborhoodId   String?
  type             PostType
  scope            PostScope       @default(LOCAL)
  status           PostStatus      @default(ACTIVE)
  title            String
  content          String          @db.Text
  viewCount        Int             @default(0)
  likeCount        Int             @default(0)
  dislikeCount     Int             @default(0)
  commentCount     Int             @default(0)
  author           User            @relation(fields: [authorId], references: [id])
  guestAuthor      GuestAuthor?    @relation(fields: [guestAuthorId], references: [id], onDelete: SetNull)
  neighborhood     Neighborhood?   @relation(fields: [neighborhoodId], references: [id])
  comments         Comment[]
  images           PostImage[]
  reports          Report[]
  reactions        PostReaction[]
  notifications    Notification[]
  hospitalReview   HospitalReview?
  placeReview      PlaceReview?
  walkRoute        WalkRoute?
  meetup           Meetup?
  marketListing    MarketListing?
  lostFoundAlert   LostFoundAlert?
  qaQuestion       QaQuestion?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  @@index([authorId])
  @@index([guestAuthorId, createdAt(sort: Desc)])
  @@index([guestIpHash, createdAt(sort: Desc)])
  @@index([guestFingerprintHash, createdAt(sort: Desc)])
  @@index([neighborhoodId, type, status, createdAt(sort: Desc)])
  @@index([type, scope, status])
}

model GuestAuthor {
  id              String    @id @default(cuid())
  displayName     String
  passwordHash    String
  ipHash          String
  fingerprintHash String?
  ipDisplay       String?
  ipLabel         String?
  posts           Post[]
  comments        Comment[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([ipHash, createdAt(sort: Desc)])
  @@index([fingerprintHash, createdAt(sort: Desc)])
}

model GuestBan {
  id              String   @id @default(cuid())
  ipHash          String
  fingerprintHash String?
  reason          String
  source          String?
  expiresAt       DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([ipHash, expiresAt])
  @@index([fingerprintHash, expiresAt])
}

model GuestViolation {
  id              String                 @id @default(cuid())
  ipHash          String
  fingerprintHash String?
  category        GuestViolationCategory
  createdAt       DateTime               @default(now())

  @@index([ipHash, createdAt(sort: Desc)])
  @@index([fingerprintHash, createdAt(sort: Desc)])
}

enum GuestViolationCategory {
  SPAM
  ADULT
  RUMOR
  POLICY
}

model PostReaction {
  id        String           @id @default(cuid())
  postId    String
  userId    String
  type      PostReactionType
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  post      Post             @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([postId, userId])
  @@index([postId, type])
  @@index([userId, createdAt(sort: Desc)])
}

enum PostReactionType {
  LIKE
  DISLIKE
}

enum CommentReactionType {
  LIKE
  DISLIKE
}

enum PostType {
  HOSPITAL_REVIEW
  PLACE_REVIEW
  WALK_ROUTE
  MEETUP
  MARKET_LISTING
  LOST_FOUND
  QA_QUESTION
  QA_ANSWER
  FREE_POST
  FREE_BOARD
  DAILY_SHARE
  PRODUCT_REVIEW
  PET_SHOWCASE
}

enum PostScope {
  LOCAL
  GLOBAL
}

enum PostStatus {
  ACTIVE
  HIDDEN
  DELETED
}

model HospitalReview {
  id            String   @id @default(cuid())
  postId        String   @unique
  post          Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  hospitalName  String?
  visitDate     DateTime?
  treatmentType String?
  totalCost     Int?
  waitTime      Int?
  rating        Int?
  costBreakdown Json?
}

model WalkRoute {
  id              String          @id @default(cuid())
  postId          String          @unique
  post            Post            @relation(fields: [postId], references: [id], onDelete: Cascade)
  routeName       String?
  distance        Float?
  duration        Int?
  difficulty      RouteDifficulty?
  coordinates     Json
  hasStreetLights Boolean?
  hasRestroom     Boolean?
  hasParkingLot   Boolean?
  safetyTags      String[] @default([])
}

enum RouteDifficulty {
  EASY
  MODERATE
  HARD
}

model MarketListing {
  id            String        @id @default(cuid())
  postId        String        @unique
  post          Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  listingType   MarketType
  price         Int
  condition     ItemCondition @default(GOOD)
  depositAmount Int?
  rentalPeriod  String?
  status        MarketStatus  @default(AVAILABLE)
}

enum MarketType {
  SELL
  RENT
  SHARE
}

enum ItemCondition {
  NEW
  LIKE_NEW
  GOOD
  FAIR
}

enum MarketStatus {
  AVAILABLE
  RESERVED
  SOLD
  CANCELLED
}

model PlaceReview {
  id           String  @id @default(cuid())
  postId       String  @unique
  post         Post    @relation(fields: [postId], references: [id], onDelete: Cascade)
  placeName    String?
  placeType    String?
  address      String?
  isPetAllowed Boolean?
  rating       Int?
}

model Meetup {
  id              String       @id @default(cuid())
  postId          String       @unique
  post            Post         @relation(fields: [postId], references: [id], onDelete: Cascade)
  meetupDate      DateTime
  location        String
  maxParticipants Int          @default(10)
  currentCount    Int          @default(0)
  status          MeetupStatus @default(OPEN)
}

enum MeetupStatus {
  OPEN
  FULL
  CLOSED
  CANCELLED
}

model LostFoundAlert {
  id               String          @id @default(cuid())
  postId           String          @unique
  post             Post            @relation(fields: [postId], references: [id], onDelete: Cascade)
  alertType        LostFoundType
  petType          String
  breed            String?
  lastSeenAt       DateTime
  lastSeenLocation String
  lat              Float?
  lng              Float?
  status           LostFoundStatus @default(ACTIVE)
}

enum LostFoundType {
  LOST
  FOUND
}

enum LostFoundStatus {
  ACTIVE
  RESOLVED
  CLOSED
}

model QaQuestion {
  id               String   @id @default(cuid())
  postId           String   @unique
  post             Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  tags             String[]
  acceptedAnswerId String?
  answerCount      Int      @default(0)
}

model Comment {
  id             String            @id @default(cuid())
  postId         String
  authorId       String
  guestAuthorId  String?
  guestDisplayName String?
  guestIpDisplay String?
  guestIpLabel   String?
  guestPasswordHash String?
  guestIpHash    String?
  guestFingerprintHash String?
  parentId       String?
  content        String            @db.Text
  status         PostStatus        @default(ACTIVE)
  likeCount      Int               @default(0)
  dislikeCount   Int               @default(0)
  post           Post              @relation(fields: [postId], references: [id], onDelete: Cascade)
  author         User              @relation(fields: [authorId], references: [id])
  guestAuthor    GuestAuthor?      @relation(fields: [guestAuthorId], references: [id], onDelete: SetNull)
  parent         Comment?          @relation("CommentReplies", fields: [parentId], references: [id])
  replies        Comment[]         @relation("CommentReplies")
  reactions      CommentReaction[]
  notifications  Notification[]
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  @@index([postId, createdAt(sort: Desc)])
  @@index([guestAuthorId, createdAt(sort: Desc)])
  @@index([guestIpHash, createdAt(sort: Desc)])
  @@index([guestFingerprintHash, createdAt(sort: Desc)])
}

model CommentReaction {
  id        String              @id @default(cuid())
  commentId String
  userId    String
  type      CommentReactionType
  comment   Comment             @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  @@unique([commentId, userId])
  @@index([commentId, type])
  @@index([userId, createdAt(sort: Desc)])
}

model PostImage {
  id     String @id @default(cuid())
  postId String
  url    String
  order  Int    @default(0)
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model Report {
  id           String        @id @default(cuid())
  reporterId   String
  targetType   ReportTarget
  targetId     String
  targetUserId String?
  reason       ReportReason
  description  String?
  status       ReportStatus  @default(PENDING)
  reporter     User          @relation("ReportedBy", fields: [reporterId], references: [id])
  targetUser   User?         @relation("ReportedUser", fields: [targetUserId], references: [id])
  post         Post?         @relation(fields: [targetId], references: [id])
  resolvedAt   DateTime?
  resolvedBy   String?
  resolution   String?
  createdAt    DateTime      @default(now())
  audits       ReportAudit[]
  @@index([targetType, targetId])
  @@index([status])
}

model ReportAudit {
  id         String       @id @default(cuid())
  reportId   String
  status     ReportStatus
  resolution String?
  resolvedBy String?
  report     Report       @relation(fields: [reportId], references: [id], onDelete: Cascade)
  resolver   User?        @relation("ReportAuditResolvedBy", fields: [resolvedBy], references: [id])
  createdAt  DateTime     @default(now())
  @@index([reportId, createdAt(sort: Desc)])
}

enum ReportTarget {
  POST
  COMMENT
  USER
}

enum ReportReason {
  SPAM
  HARASSMENT
  INAPPROPRIATE
  FAKE
  OTHER
}

enum ReportStatus {
  PENDING
  RESOLVED
  DISMISSED
}

enum SanctionLevel {
  WARNING
  SUSPEND_7D
  SUSPEND_30D
  PERMANENT_BAN
}

model UserSanction {
  id             String        @id @default(cuid())
  userId         String
  moderatorId    String
  level          SanctionLevel
  reason         String
  sourceReportId String?
  expiresAt      DateTime?
  user           User          @relation("SanctionedUser", fields: [userId], references: [id], onDelete: Cascade)
  moderator      User          @relation("SanctionModerator", fields: [moderatorId], references: [id], onDelete: Cascade)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, expiresAt])
  @@index([sourceReportId])
}

model UserBlock {
  id        String   @id @default(cuid())
  blockerId String
  blockedId String
  blocker   User     @relation("UserBlocksGiven", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked   User     @relation("UserBlocksReceived", fields: [blockedId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  @@unique([blockerId, blockedId])
  @@index([blockerId, createdAt(sort: Desc)])
  @@index([blockedId, createdAt(sort: Desc)])
}

model UserMute {
  id          String   @id @default(cuid())
  userId      String
  mutedUserId String
  user        User     @relation("UserMutesGiven", fields: [userId], references: [id], onDelete: Cascade)
  mutedUser   User     @relation("UserMutesReceived", fields: [mutedUserId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  @@unique([userId, mutedUserId])
  @@index([userId, createdAt(sort: Desc)])
  @@index([mutedUserId, createdAt(sort: Desc)])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId, createdAt(sort: Desc)])
  @@index([expiresAt])
}

model AuthAuditLog {
  id        String          @id @default(cuid())
  userId    String
  action    AuthAuditAction
  ipAddress String?
  userAgent String?
  createdAt DateTime        @default(now())
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId, createdAt(sort: Desc)])
  @@index([action])
}

model SiteSetting {
  key       String   @id
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SearchTermStat {
  termNormalized String   @id
  termDisplay    String
  count          Int      @default(1)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  @@index([count(sort: Desc), updatedAt(sort: Desc)])
  @@index([updatedAt(sort: Desc)])
}

model Notification {
  id         String                 @id @default(cuid())
  userId     String
  actorId    String?
  type       NotificationType
  entityType NotificationEntityType
  entityId   String
  postId     String?
  commentId  String?
  title      String
  body       String?
  metadata   Json?
  isRead     Boolean                @default(false)
  readAt     DateTime?
  user       User                   @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)
  actor      User?                  @relation("NotificationActor", fields: [actorId], references: [id], onDelete: SetNull)
  post       Post?                  @relation(fields: [postId], references: [id], onDelete: SetNull)
  comment    Comment?               @relation(fields: [commentId], references: [id], onDelete: SetNull)
  createdAt  DateTime               @default(now())
  updatedAt  DateTime               @updatedAt
  @@index([userId, isRead, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([entityType, entityId])
}

enum AuthAuditAction {
  PASSWORD_SET
  PASSWORD_CHANGE
  PASSWORD_RESET
}

enum NotificationType {
  COMMENT_ON_POST
  REPLY_TO_COMMENT
  REACTION_ON_POST
  SYSTEM
}

enum NotificationEntityType {
  POST
  COMMENT
  REACTION
  SYSTEM
}
